# Claude Code Reference - Book Editor

**CRITICAL: Read this file in full before making any changes to the codebase.**

This documentation provides a complete file system map for both local development and VPS production environments, enabling future Claude sessions to understand the full project context without searching.

---

## Rules

- After completing a task that involves tool use, provide a quick summary of the work you've done.
- Use parallel tool calls: When calling multiple tools with no dependencies between them, make all calls in parallel (e.g., read 3 files simultaneously instead of sequentially). If a call depends on a previous call's result, run them sequentially instead. Never use placeholders or guess missing parameters.
- Reduce hallucinations: Never speculate about code you have not opened. If the user references a specific file, you MUST read it before answering. Always investigate and read relevant files BEFORE making claims about the codebase.
- Keep CLAUDE.md accurate: Before pushing any change set to GitHub, review CLAUDE.md and update it to reflect your changes—add new files, update API endpoints, correct outdated information, and remove anything that is no longer true. This file is the single source of truth for future sessions; stale documentation causes mistakes.
- Compress working context: Once you've read and understood CLAUDE.md and the codebase, proactively compress and compact your working context as you go so you maintain continuity and avoid forgetting details, making repeat mistakes, or complaining about prompt/token length/limits. Summarize what you've learned, discard redundant detail, and keep a tight mental model of the project.

---

## Quick Reference

| Environment | Path | Port |
|-------------|------|------|
| **Local Dev** | `/home/user/book-editor` | 3001 (backend), 5173 (Vite) |
| **VPS Production** | `/root/book-editor-backend` | 3002 (external) → 3001 (internal) |

### Essential Commands

```bash
# Local Development
npx jest --config jest.config.js                   # Backend tests (522 tests)
cd frontend && npx jest --config jest.config.cjs   # Frontend tests (126 tests)
npm start                             # Start backend on port 3001
cd frontend && npm run dev            # Start Vite dev server on port 5173

# VPS Deployment
ssh root@72.62.133.62                 # Connect to VPS (srv1321944)
cd /root/book-editor-backend && ./deploy.sh   # Full deployment
curl http://localhost:3002/health     # Verify health
```

---

## VPS System Overview

| Property | Value |
|----------|-------|
| **Hostname** | srv1321944 |
| **IP Address** | 72.62.133.62 |
| **OS** | Ubuntu 25.10 (GNU/Linux 6.17.0-12-generic x86_64) |
| **Provider** | Hostinger VPS |
| **User** | root |
| **HTTPS** | Handled by Hostinger infrastructure |

---

## Complete VPS File System Map

### /root/ (User Home) - Cleaned 2026-02-06

```
/root/
├── .bash_history              # Command history
├── .bashrc                    # Shell config - CONTAINS ANTHROPIC_API_KEY export
├── .cache/                    # User cache directory
├── .docker/                   # Docker CLI configuration
├── .gitconfig                 # Git user configuration
├── .lesshst                   # Less command history
├── .local/                    # Local user data
├── .npm/                      # NPM cache
├── .profile                   # Login shell configuration
├── .ssh/                      # SSH keys for authentication
└── book-editor-backend/       # *** MAIN APPLICATION - see below ***
```

### /root/book-editor-backend/ (Application Root) - 105 Files

```
/root/book-editor-backend/
│
├── .dockerignore              # Files excluded from Docker build context
├── .env                       # *** SECRETS - auto-generated by deploy.sh ***
├── .env.example               # Template showing required environment variables
├── .git/                      # Git repository (contents not shown)
├── .gitignore                 # Files excluded from version control
├── CLAUDE.md                  # THIS DOCUMENTATION FILE
├── Dockerfile                 # Multi-stage Docker build (Node 18-alpine)
├── README.md                  # Project overview and quick start guide
│
├── __tests__/                 # Jest test suites
│   ├── integration/           # API integration tests
│   │   ├── admin.test.js      # Admin user management API tests
│   │   ├── api.test.js        # Core editing API tests
│   │   ├── projects.test.js   # Projects CRUD API tests
│   │   ├── setup.test.js      # First-time setup wizard tests
│   │   └── usage.test.js      # Token usage tracking tests
│   └── unit/                  # Unit tests for services
│       ├── appConfig.test.js        # Centralized config tests
│       ├── authMiddleware.test.js   # JWT verification tests
│       ├── authService.test.js      # Login/register logic tests
│       ├── circuitBreaker.test.js   # Circuit breaker state tests
│       ├── database.test.js         # SQLite operations tests
│       ├── errors.test.js           # Custom error class tests
│       ├── logger.test.js           # Structured logging tests
│       ├── diffService.test.js      # LCS diff algorithm tests
│       ├── documentService.test.js  # DOCX generation tests
│       ├── projects.test.js         # Project service tests
│       └── styleRules.test.js       # Style rule validation tests
│
├── config/
│   ├── app.js                 # Centralized backend configuration constants
│   └── styleGuide.js          # Reach House Style Guide - used in AI prompts
│
├── database/
│   └── migrations/            # SQLite schema migrations (run on startup)
│       ├── 001_initial_schema.js    # users, sessions, invite_codes, usage_logs
│       ├── 002_projects.js          # projects table for save/resume
│       ├── 003_custom_style_guide.js # custom_style_guide column on projects table
│       ├── 004_roles_and_limits.js  # role system (legacy: admin/management/editor/guest)
│       ├── 005_role_defaults.js     # role_defaults table for configurable limits
│       ├── 006_rename_restricted_to_guest.js  # rename 'restricted' role to 'guest'
│       ├── 007_merge_roles_to_user.js  # merge management/editor into 'user' role
│       └── 008_indexes.js             # performance indexes for common queries
│
├── deploy.sh                  # *** DEPLOYMENT SCRIPT - generates .env, builds, deploys ***
├── docs/
│   ├── API.md                 # Complete API reference with examples
│   └── DEPLOYMENT.md          # Deployment guide and troubleshooting
├── docker-compose.yml         # Docker orchestration - ports, volumes, env
├── jest.config.js             # Backend Jest configuration
│
├── frontend/                  # React frontend (Vite + Tailwind)
│   ├── __mocks__/
│   │   └── fileMock.js        # Jest mock for static file imports
│   ├── babel.config.cjs       # Babel config for Jest (ESM support)
│   ├── index.html             # SPA entry point
│   ├── jest.config.cjs        # Frontend Jest configuration
│   ├── jest.setup.js          # Jest setup (jsdom, mocks)
│   ├── package.json           # Frontend dependencies (React, Vite, etc.)
│   ├── postcss.config.js      # PostCSS config for Tailwind CSS
│   ├── public/
│   │   └── favicon.svg        # Application icon
│   ├── src/
│   │   ├── App.jsx            # Main React component - routing, layout
│   │   ├── index.css          # Global styles (Tailwind utilities)
│   │   ├── main.jsx           # React entry point - renders App
│   │   │
│   │   ├── components/        # React UI components
│   │   │   ├── AdminDashboard.jsx   # Admin user management UI
│   │   │   ├── CompletionView.jsx   # Editing complete, download prompt
│   │   │   ├── DebugLog.jsx         # Development debug panel
│   │   │   ├── DocumentAnalysis.jsx # Document stats before editing
│   │   │   ├── ErrorDisplay.jsx     # Error message display
│   │   │   ├── FileUpload.jsx       # DOCX upload component
│   │   │   ├── Header.jsx           # App header with branding
│   │   │   ├── LoginPage.jsx        # User login form
│   │   │   ├── PasswordStrength.jsx # Password requirements indicator
│   │   │   ├── ProcessingView.jsx   # Editing progress display
│   │   │   ├── RegisterPage.jsx     # User registration form
│   │   │   ├── SavedProjects.jsx    # Resume saved projects list
│   │   │   ├── SetupWizard.jsx      # First-time admin setup
│   │   │   ├── StyleGuideModal.jsx  # View/edit style guide
│   │   │   ├── Toast.jsx            # Notification toasts
│   │   │   ├── UsageDisplay.jsx     # Token usage stats
│   │   │   ├── index.js             # Component barrel exports
│   │   │   └── __tests__/           # Component tests (11 files)
│   │   │
│   │   ├── constants/
│   │   │   ├── index.js       # API config, chunk sizes, style guide copy
│   │   │   └── version.js     # VERSION, VERSION_TAG, VERSION_DATE
│   │   │
│   │   ├── contexts/
│   │   │   └── AuthContext.jsx # Auth state management (login, logout, tokens)
│   │   │
│   │   ├── hooks/
│   │   │   ├── useProjects.js  # Project list fetching hook
│   │   │   └── useToast.js     # Toast notification hook
│   │   │
│   │   ├── services/
│   │   │   └── api.js          # All API calls (edit, auth, projects, admin)
│   │   │
│   │   └── utils/
│   │       ├── documentUtils.js # Document processing helpers
│   │       ├── fetchUtils.js    # fetchWithTimeout with AbortController
│   │       └── jwtUtils.js      # JWT decode/expiry checking
│   │
│   ├── tailwind.config.js     # Tailwind CSS configuration
│   └── vite.config.js         # Vite build configuration
│
├── middleware/
│   └── auth.js                # JWT verification middleware (requireAuth, requireAdmin, optionalAuth)
│
├── package.json               # Backend dependencies (Express, better-sqlite3, etc.)
├── public/
│   └── favicon.svg            # Backend static favicon
│
├── routes/                    # Express API route handlers
│   ├── admin.js               # /api/admin/* - user management (admin only)
│   ├── api.js                 # /api/edit-chunk, /api/generate-docx, /api/generate-style-guide
│   ├── auth.js                # /api/auth/* - login, register, refresh, logout
│   ├── health.js              # /health - Docker health check endpoint
│   ├── projects.js            # /api/projects/* - save, list, load, delete
│   ├── setup.js               # /api/setup/* - first-time admin creation
│   └── usage.js               # /api/usage - token usage statistics
│
├── server.js                  # *** EXPRESS ENTRY POINT - middleware, routes, startup ***
│
├── services/                  # Business logic layer
│   ├── anthropicService.js    # Claude API communication with circuit breaker
│   ├── authService.js         # Login/register/JWT logic (bcrypt, tokens)
│   ├── database.js            # SQLite wrapper + auto-migration runner
│   ├── diffService.js         # LCS diff algorithm for Track Changes
│   ├── errors.js              # Custom error class hierarchy (AppError, etc.)
│   ├── logger.js              # Structured logging (JSON prod, readable dev)
│   │
│   ├── document/              # DOCX generation with Track Changes
│   │   ├── categorization.js  # Classify changes (spelling, grammar, etc.)
│   │   ├── comments.js        # Add review comments to changes
│   │   ├── constants.js       # Config values (author name, thresholds, flags)
│   │   ├── formatting.js      # Markdown-style format parsing (*bold*, _underline_, etc.)
│   │   ├── generation.js      # Main DOCX builder (uses docx library)
│   │   ├── index.js           # Module exports (generateDocxBuffer)
│   │   ├── paragraphs.js      # Paragraph-level processing
│   │   └── utils.js           # Stats tracking, word counting helpers
│   │
│   ├── styleRules.js          # Aggregates all style rule modules
│   └── styleRules/            # Individual style rule definitions
│       ├── concord.js         # Subject-verb agreement rules
│       ├── dialogue.js        # Quotation mark formatting
│       ├── formatting.js      # Italics, em-dashes, etc.
│       ├── grammar.js         # Grammar correction rules
│       ├── homophones.js      # their/there/they're, its/it's
│       ├── index.js           # Rule module exports
│       ├── punctuation.js     # Oxford comma, spacing
│       └── spelling.js        # UK vs US spelling (realise vs realize)
```

**Total: 105 source files** (excluding node_modules, .git, dist)

---

## Docker Container Structure (/app/)

When deployed, the Docker container runs with this structure:

```
/app/                              # Container working directory
├── config/
│   └── styleGuide.js              # Reach House Style Guide
├── data/
│   └── book-editor.db             # SQLite database (mounted volume)
├── database/
│   └── migrations/                # Schema migrations (run on startup)
├── middleware/
│   └── auth.js                    # JWT verification
├── node_modules/                  # ~150 production dependencies
│   ├── express/                   # Web framework
│   ├── helmet/                    # Security headers
│   ├── jsonwebtoken/              # JWT auth
│   ├── better-sqlite3/            # SQLite driver (native)
│   ├── bcryptjs/                  # Password hashing
│   ├── compression/               # Response compression
│   ├── cors/                      # CORS handling
│   ├── docx/                      # DOCX generation with Track Changes
│   ├── dotenv/                    # Environment variables
│   └── express-rate-limit/        # Rate limiting
├── package.json                   # Dependencies manifest
├── package-lock.json              # Locked versions
├── public/                        # Built React frontend (Vite output)
│   ├── index.html                 # SPA entry
│   ├── favicon.svg                # App icon
│   └── assets/                    # Hashed JS/CSS chunks
├── routes/                        # API route handlers
├── server.js                      # Express entry point
└── services/                      # Business logic
```

### Docker Volumes

```
/var/lib/docker/volumes/
└── book-editor-backend_book-editor-data/
    └── _data/
        └── book-editor.db         # *** SQLite DATABASE - persistent ***
```

---

## Docker Configuration

| Setting | Value |
|---------|-------|
| Base Image | node:18-alpine |
| External Port | 3002 |
| Internal Port | 3001 |
| Data Volume | `book-editor-data:/app/data` |
| Memory Limit | 2GB |
| Restart Policy | unless-stopped |

### Health Check
```bash
curl http://localhost:3002/health
# Expected: {"status":"ok","message":"Book Editor Backend is running","apiKeyConfigured":true,"databaseHealthy":true}
```

---

## Environment Variables

### Production (.env - auto-generated by deploy.sh)

| Variable | Required | Description |
|----------|----------|-------------|
| `ANTHROPIC_API_KEY` | Yes | Claude API key (set in ~/.bashrc) |
| `SETUP_SECRET` | Yes | First-time setup secret (auto-generated) |
| `JWT_SECRET` | Yes | JWT signing secret (auto-generated) |
| `NODE_ENV` | Yes | Set to "production" in docker-compose |

### Local Development

Create `.env` file with:
```bash
ANTHROPIC_API_KEY=sk-ant-...
JWT_SECRET=dev-secret-change-in-prod
SETUP_SECRET=dev-setup-secret
```

---

## API Endpoints Reference

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/health` | GET | No | Health check |
| `/api/setup/status` | GET | No | Check if setup needed |
| `/api/setup/complete` | POST | No | Create first admin |
| `/api/auth/login` | POST | No | User login |
| `/api/auth/register` | POST | No | User registration (with invite) |
| `/api/auth/refresh` | POST | Yes | Refresh access token |
| `/api/auth/logout` | POST | Yes | Logout (revoke refresh) |
| `/api/edit-chunk` | POST | Yes | Edit text with Claude |
| `/api/generate-style-guide` | POST | Yes | Generate style summary |
| `/api/generate-docx` | POST | Yes | Create Track Changes DOCX |
| `/api/projects` | GET | Yes | List user's projects |
| `/api/projects/:id` | GET | Yes | Load project |
| `/api/projects/:id` | PUT | Yes | Save/update project |
| `/api/projects/:id` | DELETE | Yes | Delete project |
| `/api/usage` | GET | Yes | Get usage statistics |
| `/api/admin/users` | GET | Admin | List all users |
| `/api/admin/users/:id` | PUT | Admin | Update user |
| `/api/admin/users/:id` | DELETE | Admin | Delete user |
| `/api/admin/invite-codes` | GET | Admin | List invite codes |
| `/api/admin/invite-codes` | POST | Admin | Create invite code |
| `/api/admin/invite-codes/:id` | DELETE | Admin | Delete unused invite code |
| `/api/admin/role-defaults` | GET | Admin | List role default limits |
| `/api/admin/role-defaults/:role` | PUT | Admin | Update role defaults |

---

## Role System

### Roles

| Role | Badge Color | Default Daily | Default Monthly |
|------|-------------|---------------|-----------------|
| **Admin** | Green | Unlimited (-1) | Unlimited (-1) |
| **User** | Amber | 500K | 10M |
| **Guest** | Gray | Restricted (0) | Restricted (0) |

### Token Limit Values (Displayed as Second Badge)

| Value | Meaning | Display |
|-------|---------|---------|
| `-1` | Unlimited | Amber "Unlimited" badge |
| `0` | Restricted | Red "Restricted" badge |
| `> 0` | Specific limit | Blue "Limited" badge |

### Role Constraints

- Users can only have ONE role at a time
- Admins CANNOT change their own role (prevents self-lockout)
- New users default to 'user' role with role defaults applied
- Role defaults are configurable in Admin Dashboard → Role Defaults tab
- All users display a second badge showing their limit status (Unlimited/Limited/Restricted)

### Frontend Role Constants (`frontend/src/constants/index.js`)

```javascript
export const USER_ROLES = {
  admin: { label: 'Admin', badgeClass: 'bg-green-500/20 text-green-400' },
  user: { label: 'User', badgeClass: 'bg-amber-500/20 text-amber-400' },
  guest: { label: 'Guest', badgeClass: 'bg-gray-500/20 text-gray-400' }
};

export const TOKEN_LIMITS = {
  UNLIMITED: -1,
  RESTRICTED: 0
};
```

---

## Key Files Reference

| File | Purpose |
|------|---------|
| `server.js` | Express server setup, middleware, route mounting |
| `services/anthropicService.js` | Claude API integration with circuit breaker |
| `services/logger.js` | Structured logging (JSON prod, readable dev) |
| `services/errors.js` | Custom error class hierarchy |
| `config/app.js` | Centralized backend configuration |
| `services/database.js` | SQLite wrapper with auto-migrations |
| `services/diffService.js` | LCS diff for Track Changes |
| `services/document/generation.js` | DOCX creation with `docx` library |
| `routes/api.js` | Core editing endpoints |
| `routes/auth.js` | Authentication endpoints |
| `middleware/auth.js` | JWT verification middleware |
| `frontend/src/services/api.js` | All frontend API calls |
| `frontend/src/contexts/AuthContext.jsx` | Auth state management |
| `frontend/src/utils/jwtUtils.js` | JWT utilities (shared) |
| `frontend/src/utils/fetchUtils.js` | Fetch with timeout (shared) |
| `config/styleGuide.js` | Reach House Style Guide |

---

## Shared Utilities (Don't Duplicate!)

### JWT Utilities (`frontend/src/utils/jwtUtils.js`)
- `decodeJwt(token)` - Decode JWT payload without verification
- `isTokenExpired(token, bufferMs)` - Check if token is expired

### Fetch Utilities (`frontend/src/utils/fetchUtils.js`)
- `fetchWithTimeout(url, options, timeoutMs)` - Fetch with AbortController

**These are imported by both `api.js` and `AuthContext.jsx`.**

---

## Git Workflow

1. Make changes locally in `/home/user/book-editor`
2. Run tests to verify (522 backend + 126 frontend = 648 total)
3. Commit and push to branch
4. Merge to main via PR
5. SSH to VPS: `cd /root/book-editor-backend && ./deploy.sh`

---

## Common Commands

### Local Development
```bash
npx jest --config jest.config.js                   # Backend tests (522)
cd frontend && npx jest --config jest.config.cjs   # Frontend tests (126)
npm start                         # Start backend on port 3001
cd frontend && npm run dev        # Start Vite dev server
cd frontend && npm run build      # Build for production
```

### VPS Production
```bash
cd /root/book-editor-backend
./deploy.sh                       # Full deployment with health check
docker compose logs -f            # View live logs
docker compose down               # Stop containers
docker compose up -d              # Start containers
```

### VPS Maintenance
```bash
# Security updates
apt update && apt upgrade -y

# Rollback failed deployment
docker tag book-editor-backend-book-editor:previous book-editor-backend-book-editor:latest
docker compose up -d

# Docker cleanup
docker system prune -f
docker image prune -a -f          # WARNING: removes all unused images

# View container resources
docker stats --no-stream

# Database backup
docker cp book-editor-backend-book-editor-1:/app/data/book-editor.db ./backup-$(date +%Y%m%d).db

# Check for zombie processes
ps aux | grep defunct
```

---

## Common Mistakes to Avoid

1. **Wrong VPS path**: Production is ONLY at `/root/book-editor-backend`
2. **Mixing up environments**: Local = `/home/user/book-editor`, VPS = `/root/book-editor-backend`
3. **Hallucinated file**: `docxService.js` does NOT exist — DOCX generation lives in `services/document/` module
4. **Duplicate utilities**: Use shared `jwtUtils.js` and `fetchUtils.js`, don't recreate
5. **Style guide sync**: Frontend `constants/index.js` STYLE_GUIDE must match backend `config/styleGuide.js`

---

## Keep This Documentation Updated

**IMPORTANT: Before pushing changes, review this file and update:**

1. **New files added** - Add to the file system map
2. **Changed API endpoints** - Update API Endpoints Reference table
3. **Modified database schema** - Update migrations list and add notes
4. **New constants or configuration** - Document in relevant sections
5. **Role system changes** - Update Role System section
6. **Version updates** - Add to Recent Versions table

This documentation enables future Claude sessions to understand the project without searching. Keeping it current reduces onboarding time and prevents mistakes.

---

## Recent Versions

| Version | Changes |
|---------|---------|
| v1.54.0 | Polish pass: fix editChunk timeout, API 404 handler, CORS 5173, broken frontend tests, dead code removal |
| v1.53.0 | Code audit: fix X-Response-Time bug, wire centralized config & logger into all files, remove duplicates |
| v1.52.0 | Complete roadmap: logger, error classes, circuit breaker, config, indexes, pagination, docs |
| v1.51.0 | Merge Management/Editor roles into single 'User' role (3 roles: Admin/User/Guest) |
| v1.50.0 | Rename 'Restricted' role to 'Guest', add limit status tags (Unlimited/Limited/Restricted) |
| v1.49.0 | Continue as Guest mode for app preview |
| v1.48.0 | Role system with configurable limits (later simplified to Admin/User/Guest in v1.51.0) |
| v1.47.0 | Comprehensive CLAUDE.md documentation |
| v1.46.0 | Editable style guide feature |
| v1.45.0 | Comprehensive formatting support |
| v1.44.x | Unlimited token limits, bug fixes |
| v1.43.x | Design system standardization |
| v1.42.0 | Rebrand to "Reach House Book Editor" |

---

## Networking

- **No nginx reverse proxy** - Direct Docker port access
- **HTTPS** - Handled by Hostinger infrastructure externally
- **Port 3002** - External access to Docker container
- **Port 3001** - Internal Express server port

---

*Last updated: 2026-02-07*
*VPS: srv1321944 (72.62.133.62)*
*Total source files: 105*
